-- ESL_PRD.AS400.VW_BKDINVSLS_BOOKED_INV_SALES source

create or replace view ESL_PRD.AS400.VW_BKDINVSLS_BOOKED_INV_SALES(
	CUST_ID,
	INV_NBR,
	LINE_NBR,
	VERSION,
	TRANS_TYPE,
	AUDIT_DATE,
	SOLD_LOC,
	EMP_LOC,
	POSTED_YEAR,
	POSTED_MONTH,
	QUANTITY,
	MODEL_NUMBER,
	MODEL_DESC,
	VENDOR_ID,
	VENDOR_NAME,
	SALE_CLASS,
	SALES_CLS_DESC,
	PROD_CAT,
	PROD_CAT_DESC,
	MER_EXTT_AMT,
	PRC_EXTT_AMT,
	WAR_EXTT_AMT,
	INS_EXTT_AMT,
	TOT_EXTT_AMT,
	TAXES,
	GRAND_TOT_LN,
	MER_EXTC_AMT,
	WAR_EXTC_AMT,
	INS_EXTC_AMT,
	TOT_EXTC_AMT,
	MIN_INST_LCD,
	IIN_INST_LCD,
	EMP_ID,
	EMP_NAME,
	OBS_CD,
	OBS_DT,
	CUST_ZIP,
	TOT_CONN_AMT,
	TOT_GE_AMT,
	TOT_RAC_AMT,
	TOT_DP_AMT,
	TOT_CASH_AMT,
	TOT_CC_AMT,
	RW,
	HVR_CHANGE_TIME,
	LAST_RUN_TIMESTAMP,
	HVR_CHANGE_OP
) as
SELECT aa.* FROM (select  
CUSTID AS CUST_ID,
INVOICENBR AS INV_NBR,
LINENBR AS LINE_NBR,
VERSION AS VERSION,
TRANSTYPE AS TRANS_TYPE,
EDL_PRD.AS400.NBR2DATE(AUDITDT) AS AUDIT_DATE,
SOLDLOC AS SOLD_LOC,
EMPLOC AS EMP_LOC,
POSTEDYR AS POSTED_YEAR,
POSTEDMTH AS POSTED_MONTH,
QTY AS QUANTITY,
MODELNBR AS MODEL_NUMBER,
MODELDESC AS MODEL_DESC,
VENDORID AS VENDOR_ID,
VENDORNAME AS VENDOR_NAME,
SLSCLASS AS SALE_CLASS,
SLSCLSDESC AS SALES_CLS_DESC,
PRODCAT AS PROD_CAT,
PRODCATDSC AS PROD_CAT_DESC,
MEREXTTAMT AS MER_EXTT_AMT,
PRCEXTTAMT AS PRC_EXTT_AMT,
WAREXTTAMT AS WAR_EXTT_AMT,
INSEXTTAMT AS INS_EXTT_AMT,
TOTEXTTAMT AS TOT_EXTT_AMT,
TAXES AS TAXES,
GRANDTOTLN AS GRAND_TOT_LN,
MEREXTCAMT AS MER_EXTC_AMT,
WAREXTCAMT AS WAR_EXTC_AMT,
INSEXTCAMT AS INS_EXTC_AMT,
TOTEXTCAMT AS TOT_EXTC_AMT,
MINSTALLCD AS MIN_INST_LCD,
IINSTALLCD AS IIN_INST_LCD,
EMPID AS EMP_ID,
EMPNAME AS EMP_NAME,
OBSCD AS OBS_CD,
EDL_PRD.AS400.NBR2DATE(OBSDT) AS OBS_DT,
CUSTZIP AS CUST_ZIP,
TOTCONNAMT AS TOT_CONN_AMT,
TOTGEAMT AS TOT_GE_AMT,
TOTRACAMT AS TOT_RAC_AMT,
TOTDPAMT AS TOT_DP_AMT,
TOTCASHAMT AS TOT_CASH_AMT,
TOTCCAMT AS TOT_CC_AMT,                     
ROW_NUMBER() OVER(PARTITION BY CUSTID, INVOICENBR,LINENBR,VERSION,AUDITDT ORDER BY HVR_CHANGE_SEQUENCE DESC) as RW,
HVR_CHANGE_TIME,
LAST_RUN_TIMESTAMP,HVR_CHANGE_OP
from "EDL_PRD"."AS400"."BKDINVSLS" cpp
inner JOIN  EDl_PRD.AS400.ETLMPPNG_LSTRUNDT CT on  MAPPING_NAME = 'm_EDL_ESL_BOOKED_INV_SALES_BKDINVSLS') aa
 WHERE RW=1 AND /*CUST_ID<>0 AND*/ 
 --aa.HVR_CHANGE_TIME::DATE-1>aa.LAST_RUN_TIMESTAMP::DATE-1;
 AUDIT_DATE::DATE >= LAST_RUN_TIMESTAMP::DATE;